<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Чат поддержки</title></head>
<body>
<div id="chat" style="height:90vh; overflow:auto; border:1px solid #ccc;"></div>
<input id="msgInput" placeholder="Сообщение..." />
<button onclick="send()">Отправить</button>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram?.WebApp;
const user = tg?.initDataUnsafe?.user;
let userId = localStorage.getItem("tg_userId");
if (!userId && user) {
  userId = `${user.username || user.first_name} (${user.id})`;
  localStorage.setItem("tg_userId", userId);
}
if (!userId) {
  alert("Открой через Telegram.");
  throw new Error("userId not found");
}
const chat = document.getElementById("chat");
const ws = new WebSocket(`wss://${location.host}/ws?user=${encodeURIComponent(userId)}`);
ws.onmessage = e => {
  const div = document.createElement("div");
  div.textContent = e.data;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
};
function send() {
  const input = document.getElementById("msgInput");
  if (input.value.trim()) {
    ws.send(input.value.trim());
    input.value = "";
  }
}
</script>
</body>
</html>
